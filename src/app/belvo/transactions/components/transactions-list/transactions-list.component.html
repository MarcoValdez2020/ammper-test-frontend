<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <p-toolbar styleClass="border-none shadow-sm bg-white">
    <ng-template pTemplate="start">
      <div class="flex items-center">
        <p-button
          icon="pi pi-arrow-left"
          [text]="true"
          severity="secondary"
          (onClick)="goBack()"
          styleClass="mr-3"
        />
        <div>
          <h1 class="text-xl font-bold text-gray-800">Transacciones</h1>
          <p class="text-sm text-gray-600">{{ selectedAccount()?.name || 'Cuenta seleccionada' }}</p>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="end">
      <p-button
        icon="pi pi-refresh"
        severity="secondary"
        [text]="true"
        (onClick)="loadData()"
        [loading]="isLoading()"
        pTooltip="Actualizar datos"
      />
    </ng-template>
  </p-toolbar>

  <div class="p-4 space-y-4">
    <!-- KPI Balance Component -->
    <app-kpi-balance
      [kpiData]="kpiBalance()"
      [isLoading]="isLoading()"
    />

    <!-- Compact Filters -->
    @if (!errorMessage()) {
      <div class="bg-white rounded-lg p-3 shadow-sm">
        <!-- Quick presets -->
        <div class="flex gap-2 overflow-x-auto pb-2 mb-2">
          @for (preset of datePresets; track preset.label) {
            <p-button
              [label]="preset.label"
              [outlined]="selectedDatePreset() !== preset.label"
              severity="secondary"
              size="small"
              styleClass="text-xs whitespace-nowrap flex-shrink-0 px-3 py-1"
              (onClick)="applyDatePreset(preset)"
            />
          }
        </div>

        <!-- Compact filter row -->
        <form [formGroup]="filtersForm" class="grid grid-cols-1 sm:grid-cols-4 gap-2 items-end">
          <div>
            <label class="text-xs text-gray-500 block mb-1">Desde</label>
            <p-datepicker
              formControlName="dateFrom"
              [showIcon]="true"
              [maxDate]="filtersForm.get('dateTo')?.value || today"
              placeholder="Fecha"
              styleClass="w-full"
              size="small"
              (onSelect)="onDateChange()"
            />
          </div>

          <div>
            <label class="text-xs text-gray-500 block mb-1">Hasta</label>
            <p-datepicker
              formControlName="dateTo"
              [showIcon]="true"
              [minDate]="filtersForm.get('dateFrom')?.value"
              [maxDate]="today"
              placeholder="Fecha"
              styleClass="w-full"
              size="small"
              (onSelect)="onDateChange()"
            />
          </div>

          <div>
            <label class="text-xs text-gray-500 block mb-1">Tipo</label>
            <p-select
              formControlName="transactionType"
              [options]="transactionTypeOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Todos"
              styleClass="w-full"
              size="small"
              (onChange)="applyFilters()"
            />
          </div>

          <div class="flex gap-1">
            <p-button
              type="button"
              icon="pi pi-times"
              severity="secondary"
              [outlined]="true"
              size="small"
              styleClass="p-1"
              pTooltip="Limpiar"
              (onClick)="resetFilters()"
            />
            <p-button
              type="button"
              icon="pi pi-check"
              size="small"
              styleClass="p-1"
              pTooltip="Aplicar"
              (onClick)="applyFilters()"
              [loading]="isLoading()"
            />
          </div>
        </form>
      </div>
    }

    <!-- Error Message -->
    @if (errorMessage()) {
      <p-message
        severity="error"
        [text]="errorMessage()!"
        styleClass="w-full"
      />
      <div class="text-center">
        <p-button
          label="Reintentar"
          icon="pi pi-refresh"
          (onClick)="loadData()"
        />
      </div>
    }

    <!-- Transactions List -->
    @if (isLoading()) {
      <!-- Loading Skeletons -->
      @for (item of [1,2,3,4,5]; track item) {
        <p-card>
          <ng-template pTemplate="content">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p-skeleton width="70%" height="1.2rem" styleClass="mb-2" />
                <p-skeleton width="50%" height="1rem" />
              </div>
              <div class="text-right">
                <p-skeleton width="4rem" height="1.2rem" styleClass="mb-1" />
                <p-skeleton width="3rem" height="1rem" />
              </div>
            </div>
          </ng-template>
        </p-card>
      }
    } @else if (filteredTransactions().length > 0) {
      <!-- Transactions Header -->
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800">Movimientos</h3>
        <span class="text-sm text-gray-500">{{ filteredTransactions().length }} transacciones</span>
      </div>

      <!-- Transactions Cards -->
      @for (transaction of filteredTransactions(); track transaction.id) {
        <p-card>
          <ng-template pTemplate="content">
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-semibold text-gray-800 truncate">{{ transaction.description }}</h4>
                  <p-tag
                    [value]="transaction.type === 'INFLOW' ? 'Ingreso' : 'Egreso'"
                    [severity]="transaction.type === 'INFLOW' ? 'success' : 'danger'"
                    styleClass="text-xs"
                  />
                </div>

                <div class="text-sm text-gray-600 space-y-1">
                  <p>{{ formatDate(transaction.value_date) }}</p>
                  @if (transaction.merchant_name) {
                    <p class="text-xs">{{ transaction.merchant_name }}</p>
                  }
                  @if (transaction.category) {
                    <p class="text-xs capitalize">{{ transaction.category }}</p>
                  }
                  <p class="text-xs"
                     [class.text-green-600]="transaction.status === 'PROCESSED'"
                     [class.text-yellow-600]="transaction.status === 'PENDING'"
                     [class.text-red-600]="transaction.status === 'FAILED'">
                    {{ getStatusLabel(transaction.status) }}
                  </p>
                </div>
              </div>

              <div class="text-right ml-4">
                <p class="font-bold text-lg"
                   [class.text-green-600]="transaction.type === 'INFLOW'"
                   [class.text-red-600]="transaction.type === 'OUTFLOW'">
                  {{ transaction.type === 'INFLOW' ? '+' : '-' }}{{ formatCurrency(transaction.amount, transaction.currency) }}
                </p>
              </div>
            </div>
          </ng-template>
        </p-card>
      }

      <!-- Load More Button -->
      @if (hasMorePages() && !isLoading()) {
        <div class="text-center pt-4">
          <p-button
            label="Cargar más transacciones"
            icon="pi pi-angle-down"
            severity="secondary"
            [outlined]="true"
            (onClick)="loadMoreTransactions()"
            [loading]="isLoadingMore()"
            styleClass="w-full"
          />
        </div>
      }
    } @else if (!isLoading()) {
      <div class="text-center py-8">
        <i class="pi pi-list text-4xl text-gray-300 mb-4"></i>
        <p class="text-gray-500">No se encontraron transacciones</p>
        <p class="text-sm text-gray-400 mt-2">No hay movimientos en el período seleccionado</p>
      </div>
    }
  </div>
</div>